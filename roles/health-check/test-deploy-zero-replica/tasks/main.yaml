---
- name: scale down zuul-executor
  block:
  - name: Set executor replica set to 0
    ansible.builtin.command:
      kubectl -n sf scale statefulsets zuul-executor --replicas=0

  - name: Ensure executor pod is down
    ansible.builtin.shell: |
      kubectl -n sf get pods
    register: _is_pod_down
    until:
      - "'zuul-executor' not in _is_pod_down.stdout"
    retries: "{{ zuul_api_retries }}"
    delay: "{{ zuul_api_delay }}"

- name: scale down zuul-web
  block:
  - name: Set zuul-web replica set to 0
    ansible.builtin.command:
      kubectl -n sf scale deployments zuul-web --replicas=0

  - name: Ensure zuul-web pod is down
    ansible.builtin.shell: |
      kubectl -n sf get pods
    register: _is_pod_down
    until:
      - "'zuul-web' not in _is_pod_down.stdout"
    retries: "{{ zuul_api_retries }}"
    delay: "{{ zuul_api_delay }}"

- name: annotate zuul-executor statefulset to trigger reconciliation
  ansible.builtin.shell: |
    kubectl annotate --overwrite statefulset zuul-executor serial=0

- name: annotate zuul-web deployment to trigger reconciliation
  ansible.builtin.shell: |
    kubectl annotate --overwrite deployment zuul-web serial=0

- name: Run sf-operator and expect reconciliation
  ansible.builtin.shell: |
    set -o pipefail
    go run main.go {{ cli_global_flags }} --context {{ context }} deploy {{ cr_path }}
  args:
    chdir: "{{ zuul.project.src_dir }}"

- name: Set executor replica set to 1
  ansible.builtin.command:
    kubectl -n sf scale statefulsets zuul-executor --replicas=1

- name: Set web replica set to 1
  ansible.builtin.command:
    kubectl -n sf scale deployments zuul-web --replicas=1

- name: Ensure executor pod is up
  ansible.builtin.shell: |
    kubectl -n sf get pods zuul-executor-0
  register: _is_pod_up
  until:
    - "'Running' in _is_pod_up.stdout"
    - "'2/2' in _is_pod_up.stdout"
  retries: "{{ zuul_api_retries }}"
  delay: "{{ zuul_api_delay }}"

- name: Ensure web pod is up
  ansible.builtin.shell: |
    kubectl -n sf get pods --field-selector status.phase=Running
  register: _is_pod_up
  until:
    - "'zuul-web' in _is_pod_up.stdout"
  retries: "{{ zuul_api_retries }}"
  delay: "{{ zuul_api_delay }}"
