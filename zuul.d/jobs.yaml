---
# Linting jobs
- job:
    name: sf-operator-ansible-lint
    description: Lint Ansible playbooks located in playbooks directory
    timeout: 900
    pre-run: playbooks/ansible-dependencies.yaml
    parent: ansible-lint
    vars:
      # NOTE(dpawlik): We don't need to add roles dir, due there is a symlink
      # done in playbooks that is related to roles dir.
      ansible_lint_playbooks_dir: playbooks
      ansible_lint_roles_dir: roles
      ansible_lint_check_all: false
    nodeset:
      nodes:
        - name: controller
          label: zuul-worker-f41

- job:
    name: sf-operator-vuln-check
    run: playbooks/run-golang-vuln.yaml
    nodeset:
      nodes:
        - name: controller
          label: zuul-worker-f41

# Go testing job
- job:
    name: sf-operator-go-test
    description: Run Go unit and integration tests via 'make test'
    pre-run: playbooks/install-golang.yaml
    timeout: 900
    irrelevant-files: &irrelevant-files
      - ".*.md$"
      - "doc/.*"
      - ".github/.*"
    nodeset:
      nodes:
        - name: controller
          label: cloud-centos-9
    run: playbooks/run-go-tests.yaml

# Documentation checking job
- job:
    name: sf-operator-doc-check
    description: Check internal and external links in documentation and fail on warnings
    pre-run: playbooks/install-golang.yaml
    timeout: 600
    files:
      - "doc/.*"
      - "mkdocs.yml"
      - "mkdocs-requirements.txt"
      - "Makefile"
    nodeset:
      nodes:
        - name: controller
          label: zuul-worker-f41
    run: playbooks/run-doc-check.yaml

# sf-operator on microshift jobs
- job:
    name: sf-operator-microshift
    parent: sf-operator-microshift-rhel
    pre-run: &pre-run
      - playbooks/health-check/dstat-pre.yaml
    post-run: &post-run
      - playbooks/health-check/dstat-post.yaml
      - playbooks/post.yaml
    timeout: 7200
    abstract: true
    irrelevant-files: *irrelevant-files
    vars:
      # post tasks artifacts directory
      output_logs_dir: ~/zuul-output/logs
      inject_dev_ssh_keys: true

- job:
    name: sf-operator-microshift-upgrade
    description: Validates a sf-operator upgrade on microshift
    parent: sf-operator-microshift
    run: playbooks/upgrade.yaml
    vars:
      sf_operator_stable_version: v0.0.64

- job:
    name: sf-operator-microshift-integration
    parent: sf-operator-microshift
    run: playbooks/run-all-tests.yaml

# minikube sf-operator jobs
- job:
    name: sf-operator-minikube
    abstract: true
    irrelevant-files: *irrelevant-files
    pre-run:
      - playbooks/install-minikube.yaml
      - playbooks/prepare-minikube.yaml
      - playbooks/install-test-dependencies.yaml
    post-run: playbooks/get-minikube-logs.yaml
    timeout: 7200
    vars:
      create_ramdisk: True
      with_loki: true
    nodeset:
      nodes:
        - name: controller
          label: cloud-centos-9-big

- job:
    name: sf-operator-minikube-integration
    parent: sf-operator-minikube
    run:
      - playbooks/run-deploy.yaml
      - playbooks/run-tests.yaml

- job:
    name: sf-operator-minikube-upgrade
    parent: sf-operator-minikube
    run: playbooks/minikube-upgrade.yaml
    vars:
      with_loki: false
